<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Â· SAMPPLAY</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 20px; border-radius: 16px; display: flex; align-items: center; gap: 20px; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .stat-info h3 { margin: 0; font-size: 1.8rem; line-height: 1; }
        .stat-info p { margin: 0; font-size: 0.9rem; color: var(--text-secondary); }
        .table-container { overflow-x: auto; background: rgba(0,0,0,0.2); border-radius: 16px; border: 1px solid var(--glass-border); }
        table { width: 100%; border-collapse: collapse; color: white; min-width: 600px; }
        th { text-align: left; padding: 15px; background: rgba(255,255,255,0.05); color: var(--text-secondary); font-weight: 600; font-size: 0.85rem; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); vertical-align: middle; }
        .btn-del { width: 32px; height: 32px; border-radius: 8px; border: 1px solid #ff4d4d; background: rgba(255, 77, 77, 0.1); color: #ff4d4d; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-del:hover { background: #ff4d4d; color: white; }
    </style>
</head>
<body class="theme-default">
    <div class="container">
        <div class="main-header">
            <div>
                <h1><i class="ri-admin-line"></i> Admin Panel</h1>
                <p style="margin:0; opacity:0.7;">Dashboard</p>
            </div>
            <a href="{{ url_for('index') }}" class="btn-glow" style="background: transparent; border: 1px solid var(--accent-danger); color: var(--accent-danger);">
                <i class="ri-logout-box-r-line"></i> Keluar
            </a>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(0, 210, 255, 0.1); color: var(--accent-cyan);"><i class="ri-group-fill"></i></div>
                <div class="stat-info">
                    <h3 id="total-users">0</h3>
                    <p>Total Users</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(255, 0, 204, 0.1); color: var(--accent-primary);"><i class="ri-music-2-fill"></i></div>
                <div class="stat-info">
                    <h3 id="total-files">0</h3>
                    <p>Total Lagu</p>
                </div>
            </div>
        </div>

        <div class="tab-container">
            <button class="tab-btn active" onclick="switchTab('users')"><i class="ri-user-settings-line"></i> Users</button>
            <button class="tab-btn" onclick="switchTab('files')"><i class="ri-folder-music-line"></i> Lagu</button>
        </div>

        <div id="tab-users" class="tab-content active">
            <div class="table-container">
                <table id="users-table">
                    <thead><tr><th>User</th><th>Role</th><th>Files</th><th>Aksi</th></tr></thead>
                    <tbody id="users-tbody"><tr><td colspan="4" class="loading">Memuat...</td></tr></tbody>
                </table>
            </div>
        </div>

        <div id="tab-files" class="tab-content">
            <div class="table-container">
                <table id="files-table">
                    <thead><tr><th>Judul Lagu</th><th>Pemilik</th><th>Ukuran</th><th>Aksi</th></tr></thead>
                    <tbody id="files-tbody"><tr><td colspan="4" class="loading">Memuat...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            const btnIndex = tab === 'users' ? 0 : 1;
            document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
        }

        async function loadAdminData() {
            try {
                const resUsers = await fetch('/admin/users');
                const users = await resUsers.json();
                const resFiles = await fetch('/list');
                const files = await resFiles.json();

                document.getElementById('total-users').textContent = users.length;
                document.getElementById('total-files').textContent = files.length;

                renderUsers(users);
                renderFiles(files, users);
            } catch (err) { alert('Gagal memuat data admin.'); }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('users-tbody');
            if (users.length === 0) { tbody.innerHTML = '<tr><td colspan="4">Kosong</td></tr>'; return; }
            let html = '';
            users.forEach(u => {
                html += `<tr>
                    <td>${u.username} <span style="font-size:0.8rem; color:gray;">(ID:${u.id})</span></td>
                    <td>${u.role}</td>
                    <td>${u.download_count}</td>
                    <td><button class="btn-del" onclick="deleteUser('${u.id}')"><i class="ri-delete-bin-line"></i></button></td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        function renderFiles(files, users) {
            const tbody = document.getElementById('files-tbody');
            if (files.length === 0) { tbody.innerHTML = '<tr><td colspan="4">Kosong</td></tr>'; return; }
            let html = '';
            files.forEach(f => {
                let uName = f.username || 'User #'+f.user_id;
                let title = f.filename.replace(/_\d+\.mp3$/, '').replace(/_/g, ' ');
                html += `<tr>
                    <td>${title}</td>
                    <td>${uName}</td>
                    <td>${(f.size/1024/1024).toFixed(2)} MB</td>
                    <td><button class="btn-del" onclick="deleteFile('${f.user_id}', '${f.filename}')"><i class="ri-delete-bin-line"></i></button></td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        async function deleteUser(id) {
            if(confirm('Hapus user ini?')) { await fetch('/admin/users/'+id, {method:'DELETE'}); loadAdminData(); }
        }
        async function deleteFile(uid, fname) {
            if(confirm('Hapus file ini?')) { 
                await fetch('/admin/files', {method:'DELETE', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_id:uid, filename:fname})}); 
                loadAdminData(); 
            }
        }
        document.addEventListener('DOMContentLoaded', loadAdminData);
    </script>
</body>
</html>
